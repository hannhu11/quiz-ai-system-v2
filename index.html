<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Tr·∫Øc nghi·ªám AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        const firebaseConfig = {
        apiKey: "AIzaSyCGAvJ8du5Xcp56ac4zPGLr2jcWPFr_qck",
        authDomain: "quiz-ai-system.firebaseapp.com",
        projectId: "quiz-ai-system",
        storageBucket: "quiz-ai-system.firebasestorage.app",
        messagingSenderId: "823165200254",
        appId: "1:823165200254:web:3e67eb0ccd1f46da5ab52f",
        measurementId: "G-16MBCN7DX6"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
    </script>
    
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-button { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .loading-spinner { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3498db; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-600 mb-2">üß† Quiz AI System</h1>
                <p class="text-gray-600">Ch·ªçn vai tr√≤ c·ªßa b·∫°n</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showAdminLogin()" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                    ‚öôÔ∏è Qu·∫£n tr·ªã vi√™n (Admin)
                </button>
                <button onclick="showUserLogin()" class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                    üë§ Ng∆∞·ªùi d√πng (User)
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-green-600 mb-2">‚öôÔ∏è ƒêƒÉng nh·∫≠p Admin</h2>
                <p class="text-gray-600">Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã</p>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <div>
                    <input type="password" id="admin-password" placeholder="M·∫≠t kh·∫©u Admin" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <button type="submit" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                    ƒêƒÉng nh·∫≠p
                </button>
                <button type="button" onclick="backToMain()" class="w-full py-2 text-gray-500 hover:text-gray-700">
                    ‚Üê Quay l·∫°i
                </button>
            </form>
        </div>
    </div>

    <!-- User Login -->
    <div id="user-login" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-blue-600 mb-2">üë§ Th√¥ng tin ng∆∞·ªùi d√πng</h2>
                <p class="text-gray-600">Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m b√†i</p>
            </div>
            
            <form onsubmit="userLogin(event)" class="space-y-4">
                <div>
                    <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                    B·∫Øt ƒë·∫ßu l√†m b√†i
                </button>
                <button type="button" onclick="backToMain()" class="w-full py-2 text-gray-500 hover:text-gray-700">
                    ‚Üê Quay l·∫°i
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-green-600">‚öôÔ∏è Admin Dashboard</h1>
                    <div class="flex space-x-4 items-center">
                        <span class="text-gray-600">Admin: <span id="admin-name" class="font-semibold"></span></span>
                        <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Admin Content -->
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìö</div>
                        <div>
                            <p class="text-gray-600">T·ªïng c√¢u h·ªèi</p>
                            <p id="total-questions-stat" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üë•</div>
                        <div>
                            <p class="text-gray-600">T·ªïng ng∆∞·ªùi d√πng</p>
                            <p id="total-users-stat" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìù</div>
                        <div>
                            <p class="text-gray-600">L∆∞·ª£t l√†m b√†i</p>
                            <p id="total-attempts-stat" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìä</div>
                        <div>
                            <p class="text-gray-600">ƒêi·ªÉm TB</p>
                            <p id="avg-score-stat" class="text-2xl font-bold text-orange-600">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-2xl">
                <div class="flex border-b mb-6">
                    <button onclick="showAdminTab('subjects')" id="tab-subjects" class="px-6 py-3 border-b-2 border-blue-500 text-blue-600 font-semibold">
                        üìñ Qu·∫£n l√Ω M√¥n h·ªçc
                    </button>
                    <button onclick="showAdminTab('questions')" id="tab-questions" class="px-6 py-3 text-gray-600 hover:text-gray-800">
                        üìö Qu·∫£n l√Ω c√¢u h·ªèi
                    </button>
                    <button onclick="showAdminTab('settings')" id="tab-settings" class="px-6 py-3 text-gray-600 hover:text-gray-800">
                        üîë C√†i ƒë·∫∑t API
                    </button>
                    <button onclick="showAdminTab('users')" id="tab-users" class="px-6 py-3 text-gray-600 hover:text-gray-800">
                        üë• Th·ªëng k√™ User
                    </button>
                    <button onclick="showAdminTab('auto-quiz')" id="tab-auto-quiz" class="px-6 py-3 text-gray-600 hover:text-gray-800">
                        ü§ñ T·∫°o b·ªô ƒë·ªÅ t·ª± ƒë·ªông t·ª´ ·∫£nh
                    </button>
                </div>

                <div class="p-6">
                    <!-- Subjects Tab -->
                    <div id="admin-tab-subjects">
                        <!-- Add Subject Form -->
                        <div class="bg-gray-50 rounded-lg p-6 mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Th√™m m√¥n h·ªçc m·ªõi</h3>
                            <form onsubmit="addSubject(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n m√¥n h·ªçc:</label>
                                    <input type="text" id="subject-name" required placeholder="V√≠ d·ª•: To√°n h·ªçc, V·∫≠t l√Ω, H√≥a h·ªçc..." 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£ (t√πy ch·ªçn):</label>
                                    <textarea id="subject-description" rows="2" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ m√¥n h·ªçc..." 
                                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <button type="submit" class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                                    ‚ûï Th√™m m√¥n h·ªçc
                                </button>
                            </form>
                        </div>

                        <!-- Subjects List -->
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">üìñ Danh s√°ch m√¥n h·ªçc</h3>
                            <div id="subjects-list" class="space-y-4">
                                <!-- Subjects will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Questions Tab -->
                    <div id="admin-tab-questions" class="hidden">
                        <!-- Add Question Form -->
                        <div class="bg-gray-50 rounded-lg p-6 mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Th√™m c√¢u h·ªèi m·ªõi</h3>
                            <form onsubmit="addQuestion(event)" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">M√¥n h·ªçc:</label>
                                        <select id="question-subject" required onchange="loadQuestionSets()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="">Ch·ªçn m√¥n h·ªçc</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">B·ªô ƒë·ªÅ:</label>
                                        <select id="question-set" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="">Ch·ªçn b·ªô ƒë·ªÅ</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫£nh c√¢u h·ªèi:</label>
                                    <input type="file" id="question-image-input" accept="image/*" required 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <div id="image-preview" class="mt-4 text-center hidden">
                                        <img id="preview-img" src="" alt="Preview" class="max-w-xs max-h-48 mx-auto rounded-lg shadow-md">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung c√¢u h·ªèi (t√πy ch·ªçn):</label>
                                    <textarea id="question-content-input" rows="3" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi n·∫øu c·∫ßn b·ªï sung..." 
                                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n A:</label>
                                        <input type="text" id="answer-a" required placeholder="Nh·∫≠p ƒë√°p √°n A" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n B:</label>
                                        <input type="text" id="answer-b" required placeholder="Nh·∫≠p ƒë√°p √°n B" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n C:</label>
                                        <input type="text" id="answer-c" required placeholder="Nh·∫≠p ƒë√°p √°n C" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n D:</label>
                                        <input type="text" id="answer-d" required placeholder="Nh·∫≠p ƒë√°p √°n D" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n ƒë√∫ng:</label>
                                    <select id="correct-answer" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        <option value="">Ch·ªçn ƒë√°p √°n ƒë√∫ng</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>

                                <button type="submit" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                    ‚ûï Th√™m c√¢u h·ªèi
                                </button>
                            </form>
                        </div>

                        <!-- Questions List -->
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Danh s√°ch c√¢u h·ªèi</h3>
                            
                            <!-- Filter controls -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3">üîç L·ªçc c√¢u h·ªèi</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">M√¥n h·ªçc</label>
                                        <select id="filter-subject" onchange="loadFilterQuestionSets()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">B·ªô ƒë·ªÅ</label>
                                        <select id="filter-question-set" onchange="filterQuestions()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="resetQuestionFilter()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                            üîÑ Reset b·ªô l·ªçc
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="admin-questions-list" class="space-y-4">
                                <!-- Questions will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="admin-tab-settings" class="hidden">
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h3 class="text-xl font-bold text-blue-800 mb-4">üîë C·∫•u h√¨nh API</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key 1:</label>
                                    <input type="password" id="admin-api-key-1" placeholder="Nh·∫≠p API Key 1" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key 2 (Backup):</label>
                                    <input type="password" id="admin-api-key-2" placeholder="Nh·∫≠p API Key 2" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <button onclick="saveAdminApiKeys()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                üíæ L∆∞u API Keys
                            </button>
                        </div>
                    </div>

                    <!-- Users Tab -->
                    <div id="admin-tab-users" class="hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üë• Th·ªëng k√™ ng∆∞·ªùi d√πng</h3>
                        <div id="users-statistics" class="space-y-4">
                            <!-- User stats will be loaded here -->
                        </div>
                    </div>

                    <!-- Auto Quiz Tab -->
                    <div id="admin-tab-auto-quiz" class="hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ü§ñ T·∫°o b·ªô ƒë·ªÅ t·ª± ƒë·ªông t·ª´ ·∫£nh</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn nhi·ªÅu ·∫£nh ƒë·ªÅ thi (c√≥ th·ªÉ k√©o th·∫£ ho·∫∑c ch·ªçn nhi·ªÅu file):</label>
                            <div id="auto-quiz-dropzone" class="border-2 border-dashed border-blue-400 rounded-lg p-6 text-center bg-blue-50 cursor-pointer hover:bg-blue-100 transition-all">
                                <span class="text-blue-600 font-semibold">K√©o & th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</span>
                                <input type="file" id="auto-quiz-image-input" accept="image/*" multiple class="hidden">
                            </div>
                        </div>
                        <div id="auto-quiz-preview" class="flex flex-wrap gap-4 mb-4"></div>
                        <button id="auto-quiz-start-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors mt-2" disabled>B·∫Øt ƒë·∫ßu OCR & sinh c√¢u h·ªèi</button>
                        <div id="auto-quiz-ocr-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-800 hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-blue-600">üß† Quiz AI System</h1>
                    <div class="flex space-x-4 items-center">
                        <span class="text-gray-600">Xin ch√†o: <span id="current-user-name" class="font-semibold text-blue-600"></span></span>
                        <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- User Content -->
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Quiz Selection -->
            <div id="quiz-selection" class="bg-white rounded-xl shadow-2xl p-6 md:p-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Ch·ªçn b·ªô ƒë·ªÅ thi</h2>
                    <p class="text-gray-600">Ch·ªçn m·ªôt b·ªô ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m b√†i</p>
                </div>
                
                <div id="quiz-sets-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Quiz sets will be loaded here -->
                </div>
            </div>

            <!-- Quiz Content -->
            <div id="user-quiz-content" class="hidden bg-white rounded-xl shadow-2xl p-6 md:p-8">
                <!-- Quiz Header -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Tr·∫Øc nghi·ªám AI</h2>
                    <div class="flex justify-center items-center space-x-4 text-gray-600">
                        <span>C√¢u <span id="user-current-question">1</span>/<span id="user-total-questions">0</span></span>
                        <span>ƒêi·ªÉm: <span id="user-score" class="font-bold text-green-600">0</span></span>
                        <span>Th·ªùi gian: <span id="quiz-timer" class="font-bold text-blue-600">00:00</span></span>
                    </div>
                </div>

                <!-- Question Content -->
                <div id="user-question-content" class="fade-in">
                    <div class="text-center mb-6">
                        <div class="relative inline-block">
                            <img id="user-question-image" src="" alt="C√¢u h·ªèi" onclick="openImageModal()" 
                                 class="max-w-full h-auto rounded-lg shadow-md mx-auto max-h-96 object-contain cursor-pointer hover:opacity-90 transition-opacity">
                            <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                üîç Ph√≥ng to
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 id="user-question-text" class="text-xl font-semibold text-gray-800 text-center mb-6"></h3>
                    </div>

                    <!-- Answer Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <button id="user-option-A" onclick="userSelectAnswer('A')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">A. </span><span class="answer-text"></span>
                        </button>
                        <button id="user-option-B" onclick="userSelectAnswer('B')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">B. </span><span class="answer-text"></span>
                        </button>
                        <button id="user-option-C" onclick="userSelectAnswer('C')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">C. </span><span class="answer-text"></span>
                        </button>
                        <button id="user-option-D" onclick="userSelectAnswer('D')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">D. </span><span class="answer-text"></span>
                        </button>
                    </div>

                    <!-- AI Explanation -->
                    <div id="user-ai-explanation" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded">
                        <div class="flex items-center mb-2">
                            <span class="text-red-600 font-bold">ü§ñ AI Gi·∫£i th√≠ch:</span>
                            <div id="user-loading-ai" class="loading-spinner ml-4 hidden"></div>
                        </div>
                        <p id="user-explanation-text" class="text-gray-700"></p>
                    </div>

                    <!-- Next Button -->
                    <div class="text-center">
                        <button id="user-next-btn" onclick="userNextQuestion()" class="hidden px-8 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors pulse-button">
                            C√¢u ti·∫øp theo ‚Üí
                        </button>
                        <button onclick="backToQuizSelection()" class="ml-4 px-6 py-2 text-gray-500 hover:text-gray-700 border border-gray-300 rounded-lg">
                            ‚Üê Ch·ªçn l·∫°i ƒë·ªÅ
                        </button>
                    </div>
                </div>

                <!-- Quiz Complete -->
                <div id="user-quiz-complete" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h3 class="text-3xl font-bold text-green-600 mb-4">Ho√†n th√†nh!</h3>
                    <div class="text-xl text-gray-700 mb-6">
                        <p>ƒêi·ªÉm c·ªßa b·∫°n: <span id="user-final-score" class="font-bold text-green-600"></span></p>
                        <p>Th·ªùi gian ho√†n th√†nh: <span id="user-final-time" class="font-bold text-blue-600"></span></p>
                    </div>
                    <div class="flex flex-wrap justify-center gap-3">
                        <button onclick="reviewQuiz()" class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                            üìã Xem l·∫°i b√†i
                        </button>
                        <button onclick="backToQuizSelection()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            üìö Ch·ªçn ƒë·ªÅ kh√°c
                        </button>
                        <button onclick="userRestartQuiz()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üîÑ L√†m l·∫°i
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quiz Review -->
            <div id="quiz-review-section" class="hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìã Xem l·∫°i b√†i l√†m</h2>
                        <button onclick="backToQuizComplete()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            ‚Üê Quay l·∫°i k·∫øt qu·∫£
                        </button>
                    </div>
                    
                    <div id="review-content" class="space-y-6">
                        <!-- Review questions will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative w-full h-full overflow-hidden">
            <div id="image-container" class="relative w-full h-full flex items-center justify-center overflow-hidden cursor-move">
                <img id="modal-image" src="" alt="C√¢u h·ªèi ph√≥ng to" class="max-w-none max-h-none object-contain select-none">
            </div>
            <div class="absolute top-4 right-4 flex space-x-2">
                <button onclick="zoomIn()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    üîç Ph√≥ng to
                </button>
                <button onclick="zoomOut()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    üîç Thu nh·ªè
                </button>
                <button onclick="resetZoom()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    ‚Üª Reset
                </button>
                <button onclick="closeImageModal()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    ‚úï ƒê√≥ng
                </button>
            </div>
            <div class="absolute bottom-4 left-4 bg-white bg-opacity-80 text-black px-3 py-2 rounded-lg text-sm">
                üí° Cu·ªôn chu·ªôt ƒë·ªÉ zoom, k√©o ƒë·ªÉ di chuy·ªÉn
            </div>
        </div>
    </div>

    <!-- Admin Image Modal -->
    <div id="admin-image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative w-full h-full overflow-hidden">
            <div id="admin-image-container" class="relative w-full h-full flex items-center justify-center overflow-hidden cursor-move">
                <img id="admin-modal-image" src="" alt="C√¢u h·ªèi ph√≥ng to" class="max-w-none max-h-none object-contain select-none">
            </div>
            <div class="absolute top-4 right-4 flex space-x-2">
                <button onclick="adminZoomIn()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">üîç Ph√≥ng to</button>
                <button onclick="adminZoomOut()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">üîç Thu nh·ªè</button>
                <button onclick="adminResetZoom()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">‚Üª Reset</button>
                <button onclick="closeAdminImageModal()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">‚úï ƒê√≥ng</button>
            </div>
            <div class="absolute bottom-4 left-4 bg-white bg-opacity-80 text-black px-3 py-2 rounded-lg text-sm">üí° Cu·ªôn chu·ªôt ƒë·ªÉ zoom, k√©o ƒë·ªÉ di chuy·ªÉn</div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div id="edit-question-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full relative">
            <h2 class="text-xl font-bold mb-4 text-gray-800">‚úèÔ∏è Ch·ªânh s·ª≠a c√¢u h·ªèi</h2>
            <form id="edit-question-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫£nh c√¢u h·ªèi:</label>
                    <div class="flex items-center space-x-2">
                        <img id="edit-preview-img" src="" alt="Preview" class="w-24 h-24 object-cover rounded cursor-pointer" onclick="openAdminImageModal(document.getElementById('edit-preview-img').src)">
                        <input type="file" id="edit-question-image-input" accept="image/*" class="p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung c√¢u h·ªèi:</label>
                    <textarea id="edit-question-content-input" rows="2" class="w-full p-2 border rounded"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n A:</label>
                        <input type="text" id="edit-answer-a" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n B:</label>
                        <input type="text" id="edit-answer-b" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n C:</label>
                        <input type="text" id="edit-answer-c" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n D:</label>
                        <input type="text" id="edit-answer-d" class="w-full p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n ƒë√∫ng:</label>
                    <select id="edit-correct-answer" class="w-full p-2 border rounded">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" onclick="closeEditQuestionModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userScore = 0;
        let userSelectedAnswer = null;
        let quizStartTime = null;
        let quizTimer = null;
        let apiKeys = { key1: '', key2: '' };
        
        // Constants
        const ADMIN_PASSWORD = 'admin123'; // Thay ƒë·ªïi m·∫≠t kh·∫©u n√†y
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            setupImagePreview();
        });
        
        // Authentication functions
        window.showAdminLogin = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
        };
        
        window.showUserLogin = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-login').classList.remove('hidden');
        };
        
        window.backToMain = function() {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('user-login').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };
        
        window.adminLogin = function(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                currentUser = 'Admin';
                currentRole = 'admin';
                document.getElementById('admin-name').textContent = currentUser;
                
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                loadAdminData();
            } else {
                alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            }
        };
        
        window.userLogin = function(event) {
            event.preventDefault();
            const userName = document.getElementById('user-name').value.trim();
            
            if (userName) {
                currentUser = userName;
                currentRole = 'user';
                document.getElementById('current-user-name').textContent = currentUser;
                
                document.getElementById('user-login').classList.add('hidden');
                document.getElementById('user-dashboard').classList.remove('hidden');
                
                loadUserData();
            } else {
                alert('Vui l√≤ng nh·∫≠p t√™n!');
            }
        };
        
        window.logout = function() {
            currentUser = null;
            currentRole = null;
            
            // Hide all dashboards
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('user-dashboard').classList.add('hidden');
            
            // Show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Clear forms
            document.getElementById('admin-password').value = '';
            document.getElementById('user-name').value = '';
        };
        
        // Global variables for new features
        let currentSubjectId = null;
        let currentQuestionSetId = null;
        let subjects = [];
        let questionSets = [];
        let currentZoom = 1;

        // ƒê·∫∑t ·ªü ngo√†i c√πng, tr∆∞·ªõc m·ªçi h√†m v√† logic li√™n quan auto-quiz
        var autoQuizImages = [];
        var autoQuizPreviewDiv = document.getElementById('auto-quiz-preview');
        var autoQuizStartBtn = document.getElementById('auto-quiz-start-btn');

        function handleFiles(files) {
            autoQuizImages = [];
            autoQuizPreviewDiv.innerHTML = '';
            Array.from(files).forEach(function(file) {
                if (!file.type.startsWith('image/')) return;
                var reader = new FileReader();
                reader.onload = function(e) {
                    autoQuizImages.push({ name: file.name, data: e.target.result });
                    var img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    img.className = 'w-24 h-24 object-cover rounded shadow border border-gray-200';
                    autoQuizPreviewDiv.appendChild(img);
                    if (autoQuizImages.length > 0) {
                        autoQuizStartBtn.disabled = false;
                    }
                };
                reader.readAsDataURL(file);
            });
            setTimeout(function() {
                if (autoQuizImages.length === 0) {
                    autoQuizStartBtn.disabled = true;
                }
            }, 500);
        }

        // Th√™m bi·∫øn ki·ªÉm so√°t ƒë√£ g√°n s·ª± ki·ªán dropzone auto-quiz ch∆∞a
        let autoQuizDropzoneEventsBound = false;

        // Admin Tab Management
        window.showAdminTab = function(tab) {
            // ·∫®n t·∫•t c·∫£ tab admin
            document.querySelectorAll('[id^="admin-tab-"]').forEach(e => e.classList.add('hidden'));
            // B·ªè active t·∫•t c·∫£ tab
            document.querySelectorAll('[id^="tab-"]').forEach(e => e.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600', 'font-semibold'));
            // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById('admin-tab-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('border-b-2', 'border-blue-500', 'text-blue-600', 'font-semibold');

            if (tab === 'auto-quiz' && !autoQuizDropzoneEventsBound) {
                // G√°n s·ª± ki·ªán cho dropzone v√† input file khi tab auto-quiz ƒë∆∞·ª£c m·ªü l·∫ßn ƒë·∫ßu
                const dropzone = document.getElementById('auto-quiz-dropzone');
                const fileInput = document.getElementById('auto-quiz-image-input');
                const previewDiv = document.getElementById('auto-quiz-preview');
                const startBtn = document.getElementById('auto-quiz-start-btn');
                if (dropzone && fileInput && previewDiv && startBtn) {
                    dropzone.addEventListener('click', function() { fileInput.click(); });
                    dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.classList.add('bg-blue-100'); });
                    dropzone.addEventListener('dragleave', function(e) { e.preventDefault(); dropzone.classList.remove('bg-blue-100'); });
                    dropzone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        dropzone.classList.remove('bg-blue-100');
                        handleFiles(e.dataTransfer.files);
                    });
                    fileInput.addEventListener('change', function(e) { handleFiles(e.target.files); });
                    autoQuizDropzoneEventsBound = true;
                }
            }
            
            // Load data for specific tabs
            if (tab === 'subjects') {
                loadSubjects();
            } else if (tab === 'questions') {
                loadSubjectsDropdown();
            } else if (tab === 'settings') {
                loadAdminApiKeys();
            } else if (tab === 'users') {
                loadUserStatistics();
            } else if (tab === 'auto-quiz') {
                // Load auto quiz data
                loadAutoQuizData();
            }
        };

        // Question Management
        window.addQuestion = async function(event) {
            event.preventDefault();
            
            const subjectId = document.getElementById('question-subject').value;
            const questionSetId = document.getElementById('question-set').value;
            const imageFile = document.getElementById('question-image-input').files[0];
            
            if (!subjectId || !questionSetId) {
                alert('Vui l√≤ng ch·ªçn m√¥n h·ªçc v√† b·ªô ƒë·ªÅ');
                return;
            }
            
            if (!imageFile) {
                alert('Vui l√≤ng ch·ªçn h√¨nh ·∫£nh');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const question = {
                    subjectId: subjectId,
                    questionSetId: questionSetId,
                    image: e.target.result,
                    content: document.getElementById('question-content-input').value,
                    answers: {
                        A: document.getElementById('answer-a').value,
                        B: document.getElementById('answer-b').value,
                        C: document.getElementById('answer-c').value,
                        D: document.getElementById('answer-d').value
                    },
                    correctAnswer: document.getElementById('correct-answer').value,
                    createdAt: new Date(),
                    createdBy: currentUser
                };

                try {
                    // Save to Firebase
                    await addDoc(collection(window.db, 'questions'), question);
                    
                    // Refresh question list
                    await loadAdminQuestions();
                    await loadAdminStats();
                    
                    // Reset form but keep subject and question set selection
                    const form = document.querySelector('#admin-tab-questions form');
                    const subjectValue = document.getElementById('question-subject').value;
                    const questionSetValue = document.getElementById('question-set').value;
                    
                    form.reset();
                    
                    // Restore selections
                    document.getElementById('question-subject').value = subjectValue;
                    if (subjectValue) {
                        await loadQuestionSets(); // Reload question sets for the subject
                        document.getElementById('question-set').value = questionSetValue;
                    }
                    
                    document.getElementById('image-preview').classList.add('hidden');
                    
                    alert('Th√™m c√¢u h·ªèi th√†nh c√¥ng!');
                } catch (error) {
                    console.error('Error adding question:', error);
                    alert('L·ªói khi th√™m c√¢u h·ªèi (offline mode)');
                }
            };
            reader.readAsDataURL(imageFile);
        };

        window.deleteAdminQuestion = async function(questionId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?')) return;
            
            try {
                // Delete from Firebase
                await deleteDoc(doc(window.db, 'questions', questionId));
                
                // Refresh displays
                await loadAdminQuestions();
                await loadAdminStats();
                
                alert('ƒê√£ x√≥a c√¢u h·ªèi!');
            } catch (error) {
                console.error('Error deleting question:', error);
                // Fallback to localStorage
                questions = questions.filter(q => q.id !== questionId);
                localStorage.setItem('quiz-questions', JSON.stringify(questions));
                displayAdminQuestions();
                loadAdminStats();
                alert('ƒê√£ x√≥a c√¢u h·ªèi (offline mode)');
            }
        };

        // API Management
        window.saveAdminApiKeys = async function() {
            apiKeys.key1 = document.getElementById('admin-api-key-1').value;
            apiKeys.key2 = document.getElementById('admin-api-key-2').value;
            
            try {
                // Save to Firebase
                await addDoc(collection(window.db, 'settings'), {
                    type: 'apiKeys',
                    keys: apiKeys,
                    updatedAt: new Date(),
                    updatedBy: currentUser
                });
                
                localStorage.setItem('gemini-api-keys', JSON.stringify(apiKeys));
                alert('L∆∞u API keys th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error saving API keys:', error);
                localStorage.setItem('gemini-api-keys', JSON.stringify(apiKeys));
                alert('ƒê√£ l∆∞u API keys (offline mode)');
            }
        };
        
        // Admin functions  
        function loadAdminData() {
            loadSubjects(); // Load subjects first
            loadAdminQuestions();
            loadAdminApiKeys();
            loadAdminStats();
            loadUserStatistics();
        }
        
        async function loadAdminQuestions() {
            try {
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questions = [];
                questionsSnapshot.forEach((doc) => {
                    questions.push({ id: doc.id, ...doc.data() });
                });
                displayAdminQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
                // Fallback to localStorage if Firebase fails
                const saved = localStorage.getItem('quiz-questions');
                if (saved) {
                    questions = JSON.parse(saved);
                    displayAdminQuestions();
                }
            }
        }
        
        function displayAdminQuestions(filteredQuestions = null) {
            const questionsList = document.getElementById('admin-questions-list');
            const questionsToShow = filteredQuestions || questions;
            
            if (questionsToShow.length === 0) {
                questionsList.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ c√¢u h·ªèi n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc</p>';
                return;
            }

            // Load filter subjects on first load
            if (!filteredQuestions) {
                loadFilterSubjects();
            }

            questionsList.innerHTML = questionsToShow.map((question, index) => {
                // Find subject and question set names
                const subject = subjects.find(s => s.id === question.subjectId);
                const questionSet = questionSets.find(qs => qs.id === question.questionSetId);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="relative">
                                        <img src="${question.image}" alt="Question ${index + 1}" class="w-20 h-20 object-cover rounded-lg cursor-pointer" onclick="openAdminImageModal('${question.image}')">
                                        <button onclick="openAdminImageModal('${question.image}')" class="absolute bottom-1 right-1 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">üîç</button>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">C√¢u ${index + 1}</h4>
                                        <p class="text-sm text-blue-600 font-medium">üìö ${subject?.name || 'Ch∆∞a r√µ m√¥n'} - üìã ${questionSet?.name || 'Ch∆∞a r√µ b·ªô ƒë·ªÅ'}</p>
                                        <p class="text-sm text-gray-600">${question.content || 'C√¢u h·ªèi t·ª´ h√¨nh ·∫£nh'}</p>
                                        <p class="text-sm text-green-600 font-medium">ƒê√°p √°n: ${question.correctAnswer}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>A. ${question.answers.A}</div>
                                    <div>B. ${question.answers.B}</div>
                                    <div>C. ${question.answers.C}</div>
                                    <div>D. ${question.answers.D}</div>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4">
                                <button onclick="editAdminQuestion('${question.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">‚úèÔ∏è S·ª≠a</button>
                                <button onclick="deleteAdminQuestion('${question.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functions
        function loadFilterSubjects() {
            const filterSubject = document.getElementById('filter-subject');
            if (!filterSubject) return;
            
            filterSubject.innerHTML = '<option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>';
            subjects.forEach(subject => {
                filterSubject.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
            });
        }

        window.loadFilterQuestionSets = function() {
            const subjectId = document.getElementById('filter-subject').value;
            const filterQuestionSet = document.getElementById('filter-question-set');
            
            filterQuestionSet.innerHTML = '<option value="">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>';
            
            if (subjectId) {
                const subjectQuestionSets = questionSets.filter(qs => qs.subjectId === subjectId);
                subjectQuestionSets.forEach(qs => {
                    filterQuestionSet.innerHTML += `<option value="${qs.id}">${qs.name}</option>`;
                });
            }
            
            // Apply filter after changing subject
            filterQuestions();
        };

        window.filterQuestions = function() {
            const subjectId = document.getElementById('filter-subject').value;
            const questionSetId = document.getElementById('filter-question-set').value;
            
            let filteredQuestions = questions;
            
            if (subjectId) {
                filteredQuestions = filteredQuestions.filter(q => q.subjectId === subjectId);
            }
            
            if (questionSetId) {
                filteredQuestions = filteredQuestions.filter(q => q.questionSetId === questionSetId);
            }
            
            displayAdminQuestions(filteredQuestions);
        };

        window.resetQuestionFilter = function() {
            document.getElementById('filter-subject').value = '';
            document.getElementById('filter-question-set').innerHTML = '<option value="">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>';
            displayAdminQuestions();
        };
        
        async function loadAdminStats() {
            // Load statistics
            document.getElementById('total-questions-stat').textContent = questions.length;
            
            try {
                const usersSnapshot = await getDocs(collection(window.db, 'userSessions'));
                const users = new Set();
                let totalAttempts = 0;
                let totalScore = 0;
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    users.add(data.userName);
                    totalAttempts++;
                    totalScore += data.score || 0;
                });
                
                document.getElementById('total-users-stat').textContent = users.size;
                document.getElementById('total-attempts-stat').textContent = totalAttempts;
                document.getElementById('avg-score-stat').textContent = totalAttempts > 0 ? 
                    Math.round((totalScore / totalAttempts / questions.length) * 100) + '%' : '0%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAdminApiKeys() {
            try {
                const settingsSnapshot = await getDocs(collection(window.db, 'settings'));
                settingsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.type === 'apiKeys') {
                        apiKeys = data.keys;
                        document.getElementById('admin-api-key-1').value = apiKeys.key1 || '';
                        document.getElementById('admin-api-key-2').value = apiKeys.key2 || '';
                    }
                });
            } catch (error) {
                console.error('Error loading API keys:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('gemini-api-keys');
                if (saved) {
                    apiKeys = JSON.parse(saved);
                    document.getElementById('admin-api-key-1').value = apiKeys.key1 || '';
                    document.getElementById('admin-api-key-2').value = apiKeys.key2 || '';
                }
            }
        }

        async function loadUserStatistics() {
            try {
                const usersSnapshot = await getDocs(collection(window.db, 'userSessions'));
                const userStats = {};
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const userName = data.userName;
                    
                    if (!userStats[userName]) {
                        userStats[userName] = {
                            name: userName,
                            attempts: 0,
                            totalScore: 0,
                            bestScore: 0,
                            bestPercentage: 0,
                            totalTime: 0,
                            sessions: []
                        };
                    }
                    
                    // Each session is counted separately 
                    userStats[userName].attempts++;
                    userStats[userName].totalScore += data.score || 0;
                    userStats[userName].totalTime += data.completionTime || 0;
                    userStats[userName].bestScore = Math.max(userStats[userName].bestScore, data.score || 0);
                    userStats[userName].bestPercentage = Math.max(userStats[userName].bestPercentage, data.percentage || 0);
                    
                    // Store session details
                    userStats[userName].sessions.push({
                        score: data.score,
                        totalQuestions: data.totalQuestions,
                        percentage: data.percentage,
                        completionTime: data.completionTime,
                        completedAt: data.completedAt,
                        questionSetId: data.questionSetId
                    });
                });
                
                // Sort sessions by date for each user
                Object.values(userStats).forEach(stat => {
                    stat.sessions.sort((a, b) => {
                        const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                        const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
                        return dateB - dateA; // Most recent first
                    });
                    
                    // Get last attempt
                    if (stat.sessions.length > 0) {
                        const lastSession = stat.sessions[0];
                        stat.lastAttempt = lastSession.completedAt?.toDate ? 
                            lastSession.completedAt.toDate().toLocaleString() : 
                            new Date(lastSession.completedAt).toLocaleString();
                    }
                });
                
                displayUserStatistics(Object.values(userStats));
            } catch (error) {
                console.error('Error loading user statistics:', error);
                // Try loading from localStorage backup
                try {
                    const backupSessions = JSON.parse(localStorage.getItem('userSessions') || '[]');
                    if (backupSessions.length > 0) {
                        console.log('Loading from localStorage backup');
                        // Process backup data similar to Firebase data
                        // This is a simplified version
                        const container = document.getElementById('users-statistics');
                        container.innerHTML = '<p class="text-yellow-600 text-center py-8">Hi·ªÉn th·ªã d·ªØ li·ªáu backup t·ª´ localStorage</p>';
                    }
                } catch (backupError) {
                    console.error('Error loading backup data:', backupError);
                }
            }
        }

        function displayUserStatistics(userStats) {
            const container = document.getElementById('users-statistics');
            
            if (userStats.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o l√†m b√†i</p>';
                return;
            }
            
            // Sort users by total attempts (most active first)
            userStats.sort((a, b) => b.attempts - a.attempts);
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√™n ng∆∞·ªùi d√πng</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T·ªïng l·∫ßn l√†m</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒêi·ªÉm cao nh·∫•t</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ph·∫ßn trƒÉm t·ªët nh·∫•t</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Th·ªùi gian TB</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L·∫ßn cu·ªëi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chi ti·∫øt</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${userStats.map((stat, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <div class="flex items-center">
                                            <div class="text-2xl mr-2">${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : 'üë§'}</div>
                                            ${stat.name}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${stat.attempts}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">
                                        ${stat.bestScore}/${stat.sessions[0]?.totalQuestions || '?'}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${stat.bestPercentage >= 80 ? 'text-green-600' : stat.bestPercentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                        ${stat.bestPercentage}%
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${formatTime(Math.round(stat.totalTime / stat.attempts))}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${stat.lastAttempt || 'Ch∆∞a c√≥'}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="showUserDetails('${stat.name}')" class="text-blue-600 hover:text-blue-800 font-medium">
                                            üìä Xem chi ti·∫øt
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- User Detail Modal -->
                <div id="user-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-96 overflow-y-auto m-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="user-detail-title" class="text-xl font-bold text-gray-800"></h3>
                            <button onclick="closeUserDetails()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                        </div>
                        <div id="user-detail-content">
                            <!-- User session details will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
        }

        window.showUserDetails = async function(userName) {
            document.getElementById('user-detail-title').textContent = `Chi ti·∫øt c·ªßa ${userName}`;
            document.getElementById('user-detail-content').innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-4"></div>
                    <span class="text-gray-600">ƒêang t·∫£i chi ti·∫øt...</span>
                </div>
            `;
            document.getElementById('user-detail-modal').classList.remove('hidden');
            
            try {
                // Load user sessions
                const usersSnapshot = await getDocs(collection(window.db, 'userSessions'));
                const userSessions = [];
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.userName === userName) {
                        userSessions.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // Sort sessions by date (most recent first)
                userSessions.sort((a, b) => {
                    const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                    const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
                    return dateB - dateA;
                });
                
                if (userSessions.length === 0) {
                    document.getElementById('user-detail-content').innerHTML = `
                        <p class="text-gray-500 text-center py-8">Ng∆∞·ªùi d√πng n√†y ch∆∞a c√≥ l·∫ßn l√†m b√†i n√†o</p>
                    `;
                    return;
                }
                
                // Display user sessions
                document.getElementById('user-detail-content').innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">üìä T·ªïng quan</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-600">${userSessions.length}</div>
                                    <div class="text-gray-600">T·ªïng l·∫ßn l√†m</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-green-600">${Math.max(...userSessions.map(s => s.score || 0))}</div>
                                    <div class="text-gray-600">ƒêi·ªÉm cao nh·∫•t</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-purple-600">${Math.max(...userSessions.map(s => s.percentage || 0))}%</div>
                                    <div class="text-gray-600">% t·ªët nh·∫•t</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-orange-600">${formatTime(Math.round(userSessions.reduce((sum, s) => sum + (s.completionTime || 0), 0) / userSessions.length))}</div>
                                    <div class="text-gray-600">Th·ªùi gian TB</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="max-h-96 overflow-y-auto">
                            <h4 class="font-semibold text-gray-800 mb-3">üìã L·ªãch s·ª≠ l√†m b√†i</h4>
                            <div class="space-y-3">
                                ${userSessions.map((session, index) => {
                                    const completedAt = session.completedAt?.toDate ? 
                                        session.completedAt.toDate() : 
                                        new Date(session.completedAt);
                                    
                                    return `
                                        <div class="border border-gray-200 rounded-lg p-4 ${index === 0 ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-sm font-medium text-gray-600">
                                                        ${index === 0 ? 'üïê L·∫ßn l√†m m·ªõi nh·∫•t' : `üìÖ L·∫ßn ${userSessions.length - index}`}
                                                    </span>
                                                    ${session.percentage >= 80 ? 'üèÜ' : session.percentage >= 60 ? 'üëç' : 'üí™'}
                                                </div>
                                                <span class="text-xs text-gray-500">
                                                    ${completedAt.toLocaleDateString()} ${completedAt.toLocaleTimeString()}
                                                </span>
                                            </div>
                                            <div class="grid grid-cols-3 gap-4 text-sm">
                                                <div>
                                                    <span class="text-gray-600">ƒêi·ªÉm:</span>
                                                    <span class="font-semibold text-green-600 ml-1">
                                                        ${session.score}/${session.totalQuestions}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Ph·∫ßn trƒÉm:</span>
                                                    <span class="font-semibold text-blue-600 ml-1">${session.percentage}%</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Th·ªùi gian:</span>
                                                    <span class="font-semibold text-purple-600 ml-1">${formatTime(session.completionTime || 0)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading user details:', error);
                document.getElementById('user-detail-content').innerHTML = `
                    <p class="text-red-500 text-center py-8">‚ùå L·ªói khi t·∫£i chi ti·∫øt ng∆∞·ªùi d√πng</p>
                `;
            }
        };

        window.closeUserDetails = function() {
            document.getElementById('user-detail-modal').classList.add('hidden');
        };

        // User Functions
        function loadUserData() {
            loadAdminApiKeys(); // Load API keys for user too
            loadQuizSets();
        }

        async function loadQuizSets() {
            try {
                // Load subjects
                const subjectsSnapshot = await getDocs(collection(window.db, 'subjects'));
                subjects = [];
                subjectsSnapshot.forEach((doc) => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                // Load question sets  
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                questionSets = [];
                questionSetsSnapshot.forEach((doc) => {
                    questionSets.push({ id: doc.id, ...doc.data() });
                });
                
                displaySubjectsForUser();
            } catch (error) {
                console.error('Error loading quiz sets:', error);
                document.getElementById('quiz-sets-list').innerHTML = `
                    <div class="col-span-2 text-center py-12">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-2xl font-bold text-gray-600 mb-4">L·ªói k·∫øt n·ªëi</h3>
                        <p class="text-gray-500">Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªÅ thi</p>
                    </div>
                `;
            }
        }

        function displaySubjectsForUser() {
            const container = document.getElementById('quiz-sets-list');
            
            if (subjects.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-12">
                        <div class="text-6xl mb-4">üìö</div>
                        <h3 class="text-2xl font-bold text-gray-600 mb-4">Ch∆∞a c√≥ m√¥n h·ªçc n√†o</h3>
                        <p class="text-gray-500">Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ th√™m m√¥n h·ªçc</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = subjects.map(subject => {
                const subjectQuestionSets = questionSets.filter(qs => qs.subjectId === subject.id);
                
                return `
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-blue-500 transition-colors">
                        <div class="text-center mb-4">
                            <div class="text-4xl mb-2">üìñ</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${subject.name}</h3>
                            <p class="text-gray-600 text-sm">${subject.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                            <p class="text-blue-600 font-semibold mt-2">S·ªë b·ªô ƒë·ªÅ: ${subjectQuestionSets.length}</p>
                        </div>
                        
                        <div class="space-y-2">
                            ${subjectQuestionSets.map(qs => `
                                <button onclick="selectQuestionSet('${qs.id}', '${subject.name}', '${qs.name}')" 
                                        class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    üìù ${qs.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.selectQuestionSet = async function(questionSetId, subjectName, questionSetName) {
            // Stop any existing timer first
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            // Reset ALL quiz states and UI elements
            currentQuestionIndex = 0;
            userScore = 0;
            userSelectedAnswer = null;
            userAnswers = []; // Reset answers array
            
            // Hide ALL quiz related UI elements
            document.getElementById('user-quiz-complete').classList.add('hidden');
            document.getElementById('quiz-review-section').classList.add('hidden');
            document.getElementById('user-quiz-content').classList.add('hidden');
            document.getElementById('quiz-selection').classList.remove('hidden');
            
            // Load questions for this question set
            try {
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questions = [];
                questionsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.questionSetId === questionSetId) {
                        questions.push({ id: doc.id, ...data });
                    }
                });
                
                if (questions.length === 0) {
                    alert('B·ªô ƒë·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o!');
                    return;
                }
                
                // Store current selection
                currentSubjectId = null; // We'll find it from questionSetId
                currentQuestionSetId = questionSetId;
                
                // Update UI to show selected quiz info
                document.getElementById('quiz-selection').querySelector('h2').textContent = 
                    `${subjectName} - ${questionSetName}`;
                document.getElementById('quiz-selection').querySelector('p').textContent = 
                    `S·∫µn s√†ng l√†m b√†i v·ªõi ${questions.length} c√¢u h·ªèi`;
                    
                // Show start button or auto-start
                setTimeout(() => {
                    if (confirm(`B·∫Øt ƒë·∫ßu l√†m b√†i "${questionSetName}" v·ªõi ${questions.length} c√¢u h·ªèi?`)) {
                        startUserQuiz();
                    }
                }, 100);
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('L·ªói khi t·∫£i c√¢u h·ªèi!');
            }
        };

        window.startUserQuiz = function() {
            document.getElementById('quiz-selection').classList.add('hidden');
            document.getElementById('user-quiz-content').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            userScore = 0;
            quizStartTime = Date.now();
            userAnswers = []; // Reset user answers for new quiz
            
            startQuizTimer();
            updateUserQuizDisplay();
        };

        window.backToQuizSelection = function() {
            document.getElementById('user-quiz-content').classList.add('hidden');
            document.getElementById('quiz-selection').classList.remove('hidden');
            
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
        };

        function startQuizTimer() {
            quizTimer = setInterval(() => {
                const elapsed = Date.now() - quizStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                document.getElementById('quiz-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function updateUserQuizDisplay() {
            if (currentQuestionIndex >= questions.length) {
                showUserQuizComplete();
                return;
            }

            const question = questions[currentQuestionIndex];
            
            document.getElementById('user-current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('user-total-questions').textContent = questions.length;
            document.getElementById('user-score').textContent = userScore;

            document.getElementById('user-question-image').src = question.image;
            document.getElementById('user-question-text').textContent = question.content || '';

            document.getElementById('user-option-A').querySelector('.answer-text').textContent = question.answers.A;
            document.getElementById('user-option-B').querySelector('.answer-text').textContent = question.answers.B;
            document.getElementById('user-option-C').querySelector('.answer-text').textContent = question.answers.C;
            document.getElementById('user-option-D').querySelector('.answer-text').textContent = question.answers.D;

            resetUserAnswerButtons();
            document.getElementById('user-ai-explanation').classList.add('hidden');
            document.getElementById('user-next-btn').classList.add('hidden');
            userSelectedAnswer = null;
        }

        window.userSelectAnswer = function(answer) {
            if (userSelectedAnswer) return;
            
            userSelectedAnswer = answer;
            
            // Store user answer for review
            if (!userAnswers) userAnswers = [];
            userAnswers[currentQuestionIndex] = answer;
            
            const question = questions[currentQuestionIndex];
            const isCorrect = answer === question.correctAnswer;

            document.querySelectorAll('.user-answer-btn').forEach(btn => {
                btn.classList.add('pointer-events-none');
                if (btn.id === `user-option-${answer}`) {
                    btn.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    btn.classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100');
                }
                if (btn.id === `user-option-${question.correctAnswer}`) {
                    btn.classList.add('border-green-500', 'bg-green-100');
                }
            });

            if (isCorrect) {
                userScore++;
                document.getElementById('user-score').textContent = userScore;
                setTimeout(() => {
                    document.getElementById('user-next-btn').classList.remove('hidden');
                }, 500);
            } else {
                getUserAIExplanation(question, answer);
            }
        };

        async function getUserAIExplanation(question, selectedAnswer) {
            const explanationDiv = document.getElementById('user-ai-explanation');
            const loadingSpinner = document.getElementById('user-loading-ai');
            const explanationText = document.getElementById('user-explanation-text');

            explanationDiv.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            explanationText.textContent = 'ƒêang ph√¢n t√≠ch c√¢u tr·∫£ l·ªùi...';

            try {
                const explanation = await callGeminiAPI(question, selectedAnswer);
                explanationText.textContent = explanation;
            } catch (error) {
                explanationText.textContent = `Kh√¥ng th·ªÉ l·∫•y gi·∫£i th√≠ch t·ª´ AI. ƒê√°p √°n ƒë√∫ng l√† ${question.correctAnswer}: ${question.answers[question.correctAnswer]}`;
            } finally {
                loadingSpinner.classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('user-next-btn').classList.remove('hidden');
                }, 1000);
            }
        }

        async function callGeminiAPI(question, selectedAnswer) {
            const prompt = `T√¥i ƒëang l√†m b√†i tr·∫Øc nghi·ªám. ƒê√¢y l√† c√¢u h·ªèi c√≥ h√¨nh ·∫£nh. T√¥i ƒë√£ ch·ªçn ƒë√°p √°n ${selectedAnswer}, nh∆∞ng c√≥ v·∫ª sai. 
H√£y gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n ƒë√≥ sai v√† ƒë√°p √°n ƒë√∫ng l√† g√¨ d·ª±a tr√™n n·ªôi dung c√¢u h·ªèi trong h√¨nh. 
H√£y r√µ r√†ng v√† d·ªÖ hi·ªÉu.

C√¢u h·ªèi: ${question.content || 'Xem trong h√¨nh'}
C√°c ƒë√°p √°n:
A. ${question.answers.A}
B. ${question.answers.B}
C. ${question.answers.C}  
D. ${question.answers.D}

ƒê√°p √°n ƒë√∫ng: ${question.correctAnswer}
ƒê√°p √°n t√¥i ch·ªçn: ${selectedAnswer}`;

            // Try API key 1 first, then API key 2
            const keys = [apiKeys.key1, apiKeys.key2].filter(key => key);
            
            for (const apiKey of keys) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    {
                                        inline_data: {
                                            mime_type: getImageMimeType(question.image),
                                            data: question.image.split(',')[1]
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                }
            }
            
            throw new Error('Both API keys failed');
        }

        function getImageMimeType(dataUrl) {
            const matches = dataUrl.match(/^data:([^;]+);base64,/);
            return matches ? matches[1] : 'image/jpeg';
        }

        window.userNextQuestion = function() {
            currentQuestionIndex++;
            updateUserQuizDisplay();
        };

        async function showUserQuizComplete() {
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            const completionTime = Math.floor((Date.now() - quizStartTime) / 1000);
            
            document.getElementById('user-question-content').classList.add('hidden');
            document.getElementById('user-quiz-complete').classList.remove('hidden');
            document.getElementById('user-final-score').textContent = `${userScore}/${questions.length}`;
            document.getElementById('user-final-time').textContent = formatTime(completionTime);
            
            // Save session to Firebase - Always create new session
            try {
                const sessionData = {
                    userName: currentUser,
                    score: userScore,
                    totalQuestions: questions.length,
                    completionTime: completionTime,
                    completedAt: new Date(),
                    questionSetId: currentQuestionSetId,
                    sessionId: Date.now().toString(), // Unique session ID
                    percentage: Math.round((userScore / questions.length) * 100)
                };
                
                // Create custom document ID with username + timestamp for easier management
                const customDocId = `${currentUser.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}`;
                await setDoc(doc(window.db, 'userSessions', customDocId), sessionData);
                console.log('Session saved successfully:', sessionData);
            } catch (error) {
                console.error('Error saving session:', error);
                // Save to localStorage as backup
                const existingSessions = JSON.parse(localStorage.getItem('userSessions') || '[]');
                existingSessions.push({
                    userName: currentUser,
                    score: userScore,
                    totalQuestions: questions.length,
                    completionTime: completionTime,
                    completedAt: new Date().toISOString(),
                    questionSetId: currentQuestionSetId,
                    sessionId: Date.now().toString(),
                    percentage: Math.round((userScore / questions.length) * 100)
                });
                localStorage.setItem('userSessions', JSON.stringify(existingSessions));
            }
        }

        window.userRestartQuiz = function() {
            // Stop existing timer
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            // Reset all states
            currentQuestionIndex = 0;
            userScore = 0;
            userSelectedAnswer = null;
            userAnswers = []; // Reset answers for new attempt
            quizStartTime = Date.now();
            
            // Hide completion and review screens, show question content
            document.getElementById('user-quiz-complete').classList.add('hidden');
            document.getElementById('quiz-review-section').classList.add('hidden');
            document.getElementById('user-question-content').classList.remove('hidden');
            
            // Restart timer and display
            startQuizTimer();
            updateUserQuizDisplay();
        };

        function resetUserAnswerButtons() {
            document.querySelectorAll('.user-answer-btn').forEach(btn => {
                btn.className = 'user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all';
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Image preview setup
        function setupImagePreview() {
            const imageInput = document.getElementById('question-image-input');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');

            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // ================== NEW FEATURES ==================
        
        // Subject Management
        window.addSubject = async function(event) {
            event.preventDefault();
            
            const subject = {
                name: document.getElementById('subject-name').value,
                description: document.getElementById('subject-description').value,
                createdAt: new Date(),
                createdBy: currentUser
            };

            try {
                const docRef = await addDoc(collection(window.db, 'subjects'), subject);
                subjects.push({ id: docRef.id, ...subject });
                
                // Create default question set
                await addDoc(collection(window.db, 'questionSets'), {
                    name: 'B·ªô ƒë·ªÅ m·∫∑c ƒë·ªãnh',
                    subjectId: docRef.id,
                    createdAt: new Date(),
                    createdBy: currentUser
                });
                
                loadSubjects();
                document.querySelector('#admin-tab-subjects form').reset();
                alert('Th√™m m√¥n h·ªçc th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error adding subject:', error);
                alert('L·ªói khi th√™m m√¥n h·ªçc (offline mode)');
            }
        };

        window.deleteSubject = async function(subjectId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n h·ªçc n√†y? T·∫•t c·∫£ b·ªô ƒë·ªÅ v√† c√¢u h·ªèi s·∫Ω b·ªã x√≥a!')) return;
            
            try {
                // Delete subject
                await deleteDoc(doc(window.db, 'subjects', subjectId));
                
                // Delete all question sets of this subject
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                questionSetsSnapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (data.subjectId === subjectId) {
                        await deleteDoc(doc(window.db, 'questionSets', docSnap.id));
                    }
                });
                
                // Delete all questions of this subject
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questionsSnapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (data.subjectId === subjectId) {
                        await deleteDoc(doc(window.db, 'questions', docSnap.id));
                    }
                });
                
                loadSubjects();
                alert('ƒê√£ x√≥a m√¥n h·ªçc v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan!');
            } catch (error) {
                console.error('Error deleting subject:', error);
                alert('L·ªói khi x√≥a m√¥n h·ªçc');
            }
        };

        window.addQuestionSet = async function(subjectId) {
            const name = prompt('Nh·∫≠p t√™n b·ªô ƒë·ªÅ m·ªõi:');
            if (!name) return;
            
            try {
                await addDoc(collection(window.db, 'questionSets'), {
                    name: name,
                    subjectId: subjectId,
                    createdAt: new Date(),
                    createdBy: currentUser
                });
                
                loadSubjects();
                alert('Th√™m b·ªô ƒë·ªÅ th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error adding question set:', error);
                alert('L·ªói khi th√™m b·ªô ƒë·ªÅ');
            }
        };

        window.deleteQuestionSet = async function(questionSetId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô ƒë·ªÅ n√†y? T·∫•t c·∫£ c√¢u h·ªèi s·∫Ω b·ªã x√≥a!')) return;
            
            try {
                // Delete question set
                await deleteDoc(doc(window.db, 'questionSets', questionSetId));
                
                // Delete all questions of this set
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questionsSnapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (data.questionSetId === questionSetId) {
                        await deleteDoc(doc(window.db, 'questions', docSnap.id));
                    }
                });
                
                loadSubjects();
                alert('ƒê√£ x√≥a b·ªô ƒë·ªÅ v√† t·∫•t c·∫£ c√¢u h·ªèi!');
            } catch (error) {
                console.error('Error deleting question set:', error);
                alert('L·ªói khi x√≥a b·ªô ƒë·ªÅ');
            }
        };

        async function loadSubjects() {
            try {
                const subjectsSnapshot = await getDocs(collection(window.db, 'subjects'));
                subjects = [];
                subjectsSnapshot.forEach((doc) => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                // Load question sets for each subject
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                questionSets = [];
                questionSetsSnapshot.forEach((doc) => {
                    questionSets.push({ id: doc.id, ...doc.data() });
                });
                
                displaySubjects();
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        function displaySubjects() {
            const container = document.getElementById('subjects-list');
            
            if (subjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ m√¥n h·ªçc n√†o</p>';
                return;
            }
            
            container.innerHTML = subjects.map(subject => {
                const subjectQuestionSets = questionSets.filter(qs => qs.subjectId === subject.id);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-xl font-bold text-gray-800">${subject.name}</h4>
                                <p class="text-gray-600">${subject.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                                <p class="text-sm text-blue-600 mt-2">S·ªë b·ªô ƒë·ªÅ: ${subjectQuestionSets.length}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="addQuestionSet('${subject.id}')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                    ‚ûï Th√™m b·ªô ƒë·ªÅ
                                </button>
                                <button onclick="deleteSubject('${subject.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                    üóëÔ∏è X√≥a m√¥n
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${subjectQuestionSets.map(qs => `
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h5 class="font-semibold text-gray-700">${qs.name}</h5>
                                            <p class="text-sm text-gray-500">ID: ${qs.id.substr(0, 8)}...</p>
                                        </div>
                                        <button onclick="deleteQuestionSet('${qs.id}')" class="px-2 py-1 bg-red-400 text-white rounded hover:bg-red-500 transition-colors text-sm">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadSubjectsDropdown() {
            try {
                const subjectsSnapshot = await getDocs(collection(window.db, 'subjects'));
                subjects = [];
                subjectsSnapshot.forEach((doc) => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                const subjectSelect = document.getElementById('question-subject');
                subjectSelect.innerHTML = '<option value="">Ch·ªçn m√¥n h·ªçc</option>';
                subjects.forEach(subject => {
                    subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading subjects dropdown:', error);
            }
        }

        window.loadQuestionSets = async function() {
            const subjectId = document.getElementById('question-subject').value;
            if (!subjectId) return;
            
            try {
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                const subjectQuestionSets = [];
                questionSetsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.subjectId === subjectId) {
                        subjectQuestionSets.push({ id: doc.id, ...data });
                    }
                });
                
                const questionSetSelect = document.getElementById('question-set');
                questionSetSelect.innerHTML = '<option value="">Ch·ªçn b·ªô ƒë·ªÅ</option>';
                subjectQuestionSets.forEach(qs => {
                    questionSetSelect.innerHTML += `<option value="${qs.id}">${qs.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading question sets:', error);
            }
        };

        // Image Zoom Functions with Mouse Interaction
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let imgPosX = 0;
        let imgPosY = 0;

        window.openImageModal = function() {
            const originalImg = document.getElementById('user-question-image');
            const modalImg = document.getElementById('modal-image');
            const container = document.getElementById('image-container');
            
            modalImg.src = originalImg.src;
            currentZoom = 1;
            imgPosX = 0;
            imgPosY = 0;
            
            updateImageTransform();
            
            document.getElementById('image-modal').classList.remove('hidden');
            
            // Setup mouse events
            setupImageInteraction();
        };

        function updateImageTransform() {
            const modalImg = document.getElementById('modal-image');
            modalImg.style.transform = `translate(${imgPosX}px, ${imgPosY}px) scale(${currentZoom})`;
        }

        function setupImageInteraction() {
            const container = document.getElementById('image-container');
            const modalImg = document.getElementById('modal-image');
            
            // Mouse wheel zoom
            container.onwheel = function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                currentZoom = Math.max(0.5, Math.min(5, currentZoom + delta));
                updateImageTransform();
            };
            
            // Mouse drag
            modalImg.onmousedown = function(e) {
                e.preventDefault();
                isDragging = true;
                dragStartX = e.clientX - imgPosX;
                dragStartY = e.clientY - imgPosY;
                container.style.cursor = 'grabbing';
            };
            
            container.onmousemove = function(e) {
                if (!isDragging) return;
                e.preventDefault();
                imgPosX = e.clientX - dragStartX;
                imgPosY = e.clientY - dragStartY;
                updateImageTransform();
            };
            
            container.onmouseup = function() {
                isDragging = false;
                container.style.cursor = 'move';
            };
            
            container.onmouseleave = function() {
                isDragging = false;
                container.style.cursor = 'move';
            };
        }

        window.closeImageModal = function() {
            document.getElementById('image-modal').classList.add('hidden');
            isDragging = false;
        };

        window.zoomIn = function() {
            currentZoom = Math.min(currentZoom + 0.3, 5);
            updateImageTransform();
        };

        window.zoomOut = function() {
            currentZoom = Math.max(currentZoom - 0.3, 0.5);
            updateImageTransform();
        };

        window.resetZoom = function() {
            currentZoom = 1;
            imgPosX = 0;
            imgPosY = 0;
            updateImageTransform();
        };

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target === modal) {
                closeImageModal();
            }
        });

        // Quiz Review Functions
        let userAnswers = []; // Store user answers for review

        window.reviewQuiz = function() {
            document.getElementById('user-quiz-complete').classList.add('hidden');
            document.getElementById('quiz-review-section').classList.remove('hidden');
            displayQuizReview();
        };

        window.backToQuizComplete = function() {
            document.getElementById('quiz-review-section').classList.add('hidden');
            document.getElementById('user-quiz-complete').classList.remove('hidden');
        };

        function displayQuizReview() {
            const reviewContent = document.getElementById('review-content');
            
            if (!userAnswers || userAnswers.length === 0) {
                reviewContent.innerHTML = '<p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ d·ªØ li·ªáu b√†i l√†m ƒë·ªÉ xem l·∫°i</p>';
                return;
            }
            
            reviewContent.innerHTML = questions.map((question, index) => {
                const userAnswer = userAnswers[index] || 'Kh√¥ng tr·∫£ l·ªùi';
                const isCorrect = userAnswer === question.correctAnswer;
                const correctAnswer = question.correctAnswer;
                
                return `
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex items-start justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">C√¢u ${index + 1}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-sm ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${isCorrect ? '‚úÖ ƒê√∫ng' : '‚ùå Sai'}
                                </span>
                                ${!isCorrect ? `<button onclick="showAIExplanationReview(${index})" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">ü§ñ Gi·∫£i th√≠ch AI</button>` : ''}
                            </div>
                        </div>
                        
                        ${question.image ? `
                            <div class="mb-4">
                                <img src="${question.image}" alt="C√¢u h·ªèi ${index + 1}" 
                                     class="max-w-full h-auto rounded-lg shadow-sm cursor-pointer hover:opacity-90 transition-opacity max-h-96 object-contain"
                                     onclick="openImageModal(); document.getElementById('modal-image').src='${question.image}'">
                            </div>
                        ` : ''}
                        
                        ${question.content ? `<p class="text-gray-700 mb-4">${question.content}</p>` : ''}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            ${Object.entries(question.answers).map(([key, value]) => {
                                let bgClass = 'bg-gray-50 border-gray-200';
                                let textClass = 'text-gray-700';
                                let icon = '';
                                
                                if (key === correctAnswer) {
                                    bgClass = 'bg-green-100 border-green-500';
                                    textClass = 'text-green-800 font-semibold';
                                    icon = '‚úÖ ';
                                } else if (key === userAnswer && key !== correctAnswer) {
                                    bgClass = 'bg-red-100 border-red-500';
                                    textClass = 'text-red-800';
                                    icon = '‚ùå ';
                                }
                                
                                return `
                                    <div class="p-3 rounded-lg border-2 ${bgClass} ${textClass}">
                                        ${icon}${key}. ${value}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="text-sm text-gray-600">
                            <p><strong>B·∫°n ch·ªçn:</strong> ${userAnswer}</p>
                            <p><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctAnswer}</p>
                        </div>
                        
                        <div id="ai-explanation-${index}" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">ü§ñ Gi·∫£i th√≠ch c·ªßa AI:</h4>
                            <div id="ai-explanation-content-${index}" class="text-blue-700">
                                <div class="flex items-center space-x-2">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                    <span>ƒêang t·∫°o gi·∫£i th√≠ch...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.showAIExplanationReview = async function(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = userAnswers[questionIndex];
            const explanationDiv = document.getElementById(`ai-explanation-${questionIndex}`);
            const explanationContent = document.getElementById(`ai-explanation-content-${questionIndex}`);
            
            explanationDiv.classList.remove('hidden');
            explanationContent.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span>ƒêang t·∫°o gi·∫£i th√≠ch...</span>
                </div>
            `;
            
            try {
                const explanation = await callGeminiAPI(question, userAnswer);
                explanationContent.innerHTML = `<p>${explanation}</p>`;
            } catch (error) {
                explanationContent.innerHTML = `
                    <p class="text-red-600">‚ùå Kh√¥ng th·ªÉ l·∫•y gi·∫£i th√≠ch t·ª´ AI.</p>
                    <p class="mt-2"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${question.correctAnswer} - ${question.answers[question.correctAnswer]}</p>
                `;
            }
        };
        
        // Modal ch·ªânh s·ª≠a c√¢u h·ªèi
        let editingQuestionId = null;
        window.editAdminQuestion = function(questionId) {
            editingQuestionId = questionId;
            const question = questions.find(q => q.id === questionId);
            if (!question) return;
            document.getElementById('edit-preview-img').src = question.image;
            document.getElementById('edit-question-content-input').value = question.content || '';
            document.getElementById('edit-answer-a').value = question.answers.A;
            document.getElementById('edit-answer-b').value = question.answers.B;
            document.getElementById('edit-answer-c').value = question.answers.C;
            document.getElementById('edit-answer-d').value = question.answers.D;
            document.getElementById('edit-correct-answer').value = question.correctAnswer;
            document.getElementById('edit-question-modal').classList.remove('hidden');
        };
        window.closeEditQuestionModal = function() {
            document.getElementById('edit-question-modal').classList.add('hidden');
            editingQuestionId = null;
        };

        // Trong h√†m displayAdminQuestions, th√™m n√∫t ph√≥ng to v√† s·ª≠a:
        questionsList.innerHTML = questionsToShow.map((question, index) => {
            // Find subject and question set names
            const subject = subjects.find(s => s.id === question.subjectId);
            const questionSet = questionSets.find(qs => qs.id === question.questionSetId);
            // Escape d·∫•u nh√°y ƒë∆°n trong src ƒë·ªÉ tr√°nh l·ªói khi truy·ªÅn v√†o onclick
            const safeImgSrc = question.image.replace(/'/g, "&#39;");
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-3">
                                <div class="relative">
                                    <img src="${question.image}" alt="Question ${index + 1}" class="w-20 h-20 object-cover rounded-lg cursor-pointer" onclick="openAdminImageModal('${safeImgSrc}')">
                                    <button type="button" onclick="openAdminImageModal('${safeImgSrc}')" class="absolute bottom-1 right-1 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">üîç</button>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">C√¢u ${index + 1}</h4>
                                    <p class="text-sm text-blue-600 font-medium">üìö ${subject?.name || 'Ch∆∞a r√µ m√¥n'} - üìã ${questionSet?.name || 'Ch∆∞a r√µ b·ªô ƒë·ªÅ'}</p>
                                    <p class="text-sm text-gray-600">${question.content || 'C√¢u h·ªèi t·ª´ h√¨nh ·∫£nh'}</p>
                                    <p class="text-sm text-green-600 font-medium">ƒê√°p √°n: ${question.correctAnswer}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>A. ${question.answers.A}</div>
                                <div>B. ${question.answers.B}</div>
                                <div>C. ${question.answers.C}</div>
                                <div>D. ${question.answers.D}</div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="editAdminQuestion('${question.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">‚úèÔ∏è S·ª≠a</button>
                            <button onclick="deleteAdminQuestion('${question.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Th√™m modal ph√≥ng to ·∫£nh cho admin (d√πng l·∫°i modal c≈© nh∆∞ng id kh√°c)
        let adminCurrentZoom = 1, adminImgPosX = 0, adminImgPosY = 0, adminIsDragging = false, adminDragStartX = 0, adminDragStartY = 0;
        window.openAdminImageModal = function(imgSrc) {
            console.log('[ADMIN] Click ph√≥ng to ·∫£nh:', imgSrc);
            if (!imgSrc || imgSrc === 'null' || imgSrc === 'undefined') {
                alert('·∫¢nh kh√¥ng h·ª£p l·ªá ho·∫∑c ch∆∞a c√≥ ·∫£nh!');
                return;
            }
            const modal = document.getElementById('admin-image-modal');
            const modalImg = document.getElementById('admin-modal-image');
            modalImg.src = imgSrc;
            adminCurrentZoom = 1; adminImgPosX = 0; adminImgPosY = 0;
            updateAdminImageTransform();
            modal.classList.remove('hidden');
            setupAdminImageInteraction();
        };
        function updateAdminImageTransform() {
            const modalImg = document.getElementById('admin-modal-image');
            modalImg.style.transform = `translate(${adminImgPosX}px, ${adminImgPosY}px) scale(${adminCurrentZoom})`;
        }
        function setupAdminImageInteraction() {
            const container = document.getElementById('admin-image-container');
            const modalImg = document.getElementById('admin-modal-image');
            container.onwheel = function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                adminCurrentZoom = Math.max(0.5, Math.min(5, adminCurrentZoom + delta));
                updateAdminImageTransform();
            };
            modalImg.onmousedown = function(e) {
                e.preventDefault();
                adminIsDragging = true;
                adminDragStartX = e.clientX - adminImgPosX;
                adminDragStartY = e.clientY - adminImgPosY;
                container.style.cursor = 'grabbing';
            };
            container.onmousemove = function(e) {
                if (!adminIsDragging) return;
                e.preventDefault();
                adminImgPosX = e.clientX - adminDragStartX;
                adminImgPosY = e.clientY - adminDragStartY;
                updateAdminImageTransform();
            };
            container.onmouseup = function() { adminIsDragging = false; container.style.cursor = 'move'; };
            container.onmouseleave = function() { adminIsDragging = false; container.style.cursor = 'move'; };
        }
        window.closeAdminImageModal = function() { document.getElementById('admin-image-modal').classList.add('hidden'); adminIsDragging = false; };
        window.adminZoomIn = function() { adminCurrentZoom = Math.min(adminCurrentZoom + 0.3, 5); updateAdminImageTransform(); };
        window.adminZoomOut = function() { adminCurrentZoom = Math.max(adminCurrentZoom - 0.3, 0.5); updateAdminImageTransform(); };
        window.adminResetZoom = function() { adminCurrentZoom = 1; adminImgPosX = 0; adminImgPosY = 0; updateAdminImageTransform(); };

        // Auto Quiz - Upload nhi·ªÅu ·∫£nh, preview
        const dropzone = document.getElementById('auto-quiz-dropzone');
        const fileInput = document.getElementById('auto-quiz-image-input');
        const previewDiv = document.getElementById('auto-quiz-preview');
        const startBtn = document.getElementById('auto-quiz-start-btn');
        var autoQuizImages = [];

        if (dropzone && fileInput && previewDiv && startBtn) {
            dropzone.addEventListener('click', function() { fileInput.click(); });
            dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.classList.add('bg-blue-100'); });
            dropzone.addEventListener('dragleave', function(e) { e.preventDefault(); dropzone.classList.remove('bg-blue-100'); });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('bg-blue-100');
                handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', function(e) { handleFiles(e.target.files); });
        }

        // Th√™m bi·∫øn l∆∞u API key Google Cloud Vision (hardcode ho·∫∑c cho ph√©p nh·∫≠p ·ªü ph·∫ßn c√†i ƒë·∫∑t n·∫øu mu·ªën)
        const GOOGLE_VISION_API_KEY = 'AIzaSyAg1ENLEMRu6Z1wKuCbo5ovAeR86a6BoLU';

        // Th√™m div preview text OCR sau n√∫t startBtn
        // Trong ph·∫ßn admin-tab-auto-quiz:
        // <div id="auto-quiz-ocr-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-800 hidden"></div>

        // Th√™m v√†o sau n√∫t startBtn trong HTML:
        // <div id="auto-quiz-ocr-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-800 hidden"></div>

        // JS x·ª≠ l√Ω OCR khi nh·∫•n n√∫t
        if (startBtn) {
            startBtn.addEventListener('click', async function() {
                if (autoQuizImages.length === 0) return;
                startBtn.disabled = true;
                startBtn.textContent = 'ƒêang nh·∫≠n di·ªán OCR...';
                document.getElementById('auto-quiz-ocr-result').classList.add('hidden');
                let allText = '';
                let ocrResults = [];
                for (let i = 0; i < autoQuizImages.length; i++) {
                    const img = autoQuizImages[i];
                    // G·ªçi Google Cloud Vision API
                    try {
                        const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                requests: [{
                                    image: { content: img.data.split(',')[1] },
                                    features: [{ type: 'TEXT_DETECTION' }]
                                }]
                            })
                        });
                        const data = await res.json();
                        const text = data.responses?.[0]?.fullTextAnnotation?.text || '';
                        ocrResults.push({ name: img.name, text });
                        allText += `--- ·∫¢nh: ${img.name} ---\n${text}\n\n`;
                    } catch (e) {
                        ocrResults.push({ name: img.name, text: '[L·ªói OCR]' });
                        allText += `--- ·∫¢nh: ${img.name} ---\n[L·ªói OCR]\n\n`;
                    }
                }
                // Hi·ªÉn th·ªã preview text OCR
                const ocrDiv = document.getElementById('auto-quiz-ocr-result');
                ocrDiv.textContent = allText.trim();
                ocrDiv.classList.remove('hidden');
                startBtn.disabled = false;
                startBtn.textContent = 'B·∫Øt ƒë·∫ßu OCR & sinh c√¢u h·ªèi';
                // L∆∞u l·∫°i text OCR cho b∆∞·ªõc ti·∫øp theo
                window.autoQuizOcrText = allText.trim();
                window.autoQuizOcrResults = ocrResults;
            });
        }

    </script>
</body>
</html> 